#!/usr/bin/python
# -*- coding: utf-8 -*-

#TODO: выбор иконки
#        иконки по времени дня
#      кеширование
#      lua-виджет
#      timeout

import urllib
import lxml.html


def unpack(list_):
    return tuple(list_)

txt = []
page = urllib.urlopen('http://www.gismeteo.ru/city/daily/13076/')
doc = lxml.html.document_fromstring(page.read())
# погодка в аэропорте
for i in doc.xpath('//*[@id="weather"]')[0].getiterator():
    if i.text != None:
        txt.append(i.text)
    #getnext
    #items
    #iter
    #iterchildren
    #itersibilings
    #values
    #keys
# parse txt for complete forecast
new_txt = []
for i in txt:
    if len(i.lstrip()):
        new_txt.append(i)

txt = new_txt
new_txt = []
for i in range(len(txt)):
    if i > 3:
        new_txt.append(txt[i])
txt = new_txt
sky=txt[0].split(',')[0]
# выберем иконку {
if sky == u'Ясно':
    sky = '/usr/share/icons/gnome/48x48/status/weather-clear.png'
elif sky == u'Пасмурно':
    sky = '/usr/share/icons/gnome/48x48/status/weather-overcast.png'
# }
txt.insert(0, sky)
# приукрaсим строки
tail = u'''naughty.notify({ title="Погода", icon="%s", text=" %s\\n <b>Температура:</b> %s\n <b>Давление:</b> %s %s\n <b>Ветер:</b> %s %s %s\n <b>Влажность:</b> %s %s" } )
''' %(tuple(txt[0:10]))
print tail.encode('UTF-8')
with open('/tmp/myforecast', 'w') as f:
    f.write(tail.encode('utf-8'))
